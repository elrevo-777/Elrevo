<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #4CAF50; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e8f5e9; }
    
    /* üî• STATUS STYLING */
    .status-new {
      background: #4CAF50 !important;
      color: white !important;
      font-weight: bold !important;
      padding: 6px 12px !important;
      border-radius: 20px !important;
      font-size: 14px;
      text-align: center;
    }
    .status-read {
      background: #bbbbbb !important;
      color: white !important;
      padding: 6px 12px !important;
      border-radius: 20px !important;
      font-size: 14px;
      text-align: center;
    }
    
    button { padding: 8px 12px; margin: 0 4px; cursor: pointer; border: none; border-radius: 4px; }
    .replyBtn { background: #2196F3; color: white; }
    .deleteBtn { background: #f44336; color: white; }
    #logout { background: #ff9800; color: white; float: right; }
    #searchInput { padding: 10px; width: 350px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
    #loading { text-align: center; padding: 30px; font-size: 18px; color: #666; }
  </style>
</head>
<body>

<h2>Messages Dashboard</h2>
<button id="logout">Logout</button>
<br><br>
<input type="text" id="searchInput" placeholder="Search by name, email, or subject...">

<div id="loading">Loading messages, please wait...</div>

<table style="display: none;">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Subject</th>
      <th>Message</th>
      <th>Status</th>
      <th>Action</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="messages"></tbody>
</table>

<!-- Modal (same as before) -->
<div id="messageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
  <div style="background:white; max-width:700px; margin:50px auto; padding:30px; border-radius:10px; position:relative;">
    <button id="closeModal" style="position:absolute; top:10px; right:15px; font-size:24px; background:none; border:none; cursor:pointer;">√ó</button>
    <h3 id="mSubject" style="margin-top:0; color:#4CAF50;"></h3>
    <p><b>Name:</b> <span id="mName"></span></p>
    <p><b>Email:</b> <span id="mEmail"></span></p>
    <p><b>Message:</b></p>
    <p id="mMessage" style="background:#f2f2f2; padding:15px; border-radius:5px;"></p>
    <p style="color:gray; font-size:13px;">Received: <span id="mDate"></span></p>
  </div>
</div>

<script type="module">
  // Same imports and config as before...
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA4t8qqUiO7KqgeRNKQlMINmKum1if9sFM",
    authDomain: "elegant-revolution.firebaseapp.com",
    projectId: "elegant-revolution",
    storageBucket: "elegant-revolution.firebasestorage.app",
    messagingSenderId: "775296660246",
    appId: "1:775296660246:web:d24fdc77e6dd7c227c1637",
    measurementId: "G-Q6BNJ57JB6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const modal = document.getElementById("messageModal");
  const loading = document.getElementById("loading");
  const table = document.querySelector("table");
  let allMessages = [];

  document.getElementById("closeModal").onclick = () => modal.style.display = "none";
  window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

  function openModal(data) {
    document.getElementById("mName").innerText = data.name || "N/A";
    document.getElementById("mEmail").innerText = data.email || "N/A";
    document.getElementById("mSubject").innerText = data.subject || "(No subject)";
    document.getElementById("mMessage").innerText = data.message || "(No message)";
    document.getElementById("mDate").innerText = data.createdAt?.toDate().toLocaleString() || "Unknown";
    modal.style.display = "block";
  }

  function renderMessages(messages) {
    const tbody = document.getElementById("messages");
    tbody.innerHTML = "";
    loading.style.display = "none";
    table.style.display = "table";

    if (messages.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:gray;">No messages found</td></tr>`;
      return;
    }

    messages.forEach(item => {
      const d = item;
      const status = (d.status || "new").toLowerCase();
      const statusClass = status === "read" ? "status-read" : "status-new";
      const statusText = status === "read" ? "Read" : "New";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.name || ""}</td>
        <td>${d.email || ""}</td>
        <td>${d.subject || ""}</td>
        <td>\( {(d.message || "").substring(0, 60)} \){d.message?.length > 60 ? "..." : ""}</td>
        <td class="\( {statusClass}"> \){statusText}</td>
        <td>
          <button class="replyBtn">‚úâÔ∏è Reply</button>
          <button class="deleteBtn">üóëÔ∏è Delete</button>
        </td>
        <td>${d.createdAt?.toDate().toLocaleString() || ""}</td>
      `;

      // Same reply, delete, click functions as before...
      tr.querySelector(".replyBtn").onclick = (e) => {
        e.stopPropagation();
        const subject = encodeURIComponent("Re: " + (d.subject || "Your Message"));
        const body = encodeURIComponent(`Hello \( {d.name || "there"},\n\nThank you for your message:\n" \){d.message || ""}"\n\nWe will get back to you soon.\n\nBest,\nElrevo Team`);
        window.open(`mailto:\( {d.email}?subject= \){subject}&body=${body}`);
      };

      tr.querySelector(".deleteBtn").onclick = async (e) => {
        e.stopPropagation();
        if (confirm("Are you sure you want to delete this message?")) {
          try {
            await deleteDoc(doc(db, "contacts", d.id));
            alert("Message deleted!");
            loadMessages();
          } catch (err) {
            alert("Delete failed!");
            console.error(err);
          }
        }
      };

      tr.onclick = async () => {
        openModal(d);
        if (status !== "read") {
          try {
            await updateDoc(doc(db, "contacts", d.id), { status: "read" });
            loadMessages();
          } catch (err) {
            console.error(err);
          }
        }
      };

      tbody.appendChild(tr);
    });
  }

  async function loadMessages() {
    try {
      const q = query(collection(db, "contacts"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderMessages(allMessages);
    } catch (error) {
      loading.innerHTML = "‚ùå Error loading messages. Check console (F12)";
      console.error("Firestore Error:", error);
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "admin.html";
    } else {
      loadMessages();
    }
  });

  document.getElementById("searchInput").addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = allMessages.filter(m => 
      (m.name || "").toLowerCase().includes(term) ||
      (m.email || "").toLowerCase().includes(term) ||
      (m.subject || "").toLowerCase().includes(term)
    );
    renderMessages(filtered);
  });

  document.getElementById("logout").onclick = async () => {
    try {
      await signOut(auth);
      alert("Logged out successfully!");
      window.location.href = "admin.html";
    } catch (err) {
      alert("Logout failed!");
      console.error(err);
    }
  };
</script>

</body>
</html>
